# https://cloud.google.com/cloud-build/docs/securing-builds/use-encrypted-secrets-credentials#encrypting_an_environment_variable_using_the_cryptokey
secrets:
  - kmsKeyName: projects/quick-payments-216313/locations/global/keyRings/KEY_RING_1/cryptoKeys/NPM_AUTH_TOKEN
    secretEnv:
      NPM_AUTH_TOKEN: CiQALtjyR32vPnKsZisaa5iX7CCz2y2aBDlS4yC1J1WxlgNy2JsSTQAF4p7Wxd6S/wtgqPC5QOc/OKn/54YOWWCGCK8yKjlAT7iILz10mlXZEI4lwEgtS/9bxZNQ6tyiYHh3RtrS+SGp3qw/0nAvcCJCifzu

steps:
  # install JS dependencies
  - name: node:10
    dir: 'frontend'
    args: ['yarn', 'install']

  # test JS client
  - name: node:10
    dir: 'frontend'
    args: ['yarn', 'test-ci']

  - name: node:10
    dir: 'frontend'
    args: ['yarn', 'babel-node', 'scripts/publish-npm-packages.js']
    secretEnv: ['NPM_AUTH_TOKEN']

  # TODO: cache node_modules

  # check Elixir formatting
  - name: elixir:1.7
    dir: 'backend'
    args: ['mix', 'format', '--check-formatted']
    waitFor: ['-']  # the '-' indicates that this step begins immediately

  # install Hex
  - name: elixir:1.7
    dir: 'backend'
    args: ['mix', 'local.hex', '--force']
    waitFor: ['-']  # the '-' indicates that this step begins immediately

  - name: elixir:1.7
    dir: 'backend'
    args: ['mix', 'local.rebar', '--force']
    waitFor: ['-']  # the '-' indicates that this step begins immediately

  # TODO: create custom Dockerfile to skip all this (^^)

  # install dependencies
  - name: elixir:1.7
    dir: 'backend'
    args: ['mix', 'deps.get']

  # test Elixir application
  - name: elixir:1.7
    dir: 'backend'
    args: ['mix', 'test']

# TODO: mix credo
